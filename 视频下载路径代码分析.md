# 视频下载路径代码分析

## 概述

本文档分析了Telegram Media Downloader项目中视频下载路径相关的代码实现，包括路径构建逻辑、配置管理和状态记录等核心功能。

## 核心代码结构

### 1. 配置文件 (config_user.yaml)

```yaml
# 基础下载路径配置
save_path: /home/ec2-user/media

# 文件路径前缀配置
file_path_prefix:
- chat_id           # 聊天ID/频道ID
- media_datetime    # 媒体日期时间

# 文件名前缀配置
file_name_prefix:
- message_id        # 消息ID
- file_name         # 文件名
file_name_prefix_split: ' - '  # 分隔符

# 日期格式
date_format: '%Y_%m'  # 年_月格式
```

### 2. 路径构建核心逻辑

#### 2.1 文件保存路径构建 (`module/app.py`)

```python
    def get_file_save_path(
        self, media_type: str, chat_id: str, media_datetime: str
    ) -> str:
        """获取文件保存路径前缀"""
        res: str = self.save_path  # 基础保存路径
        
        for prefix in self.file_path_prefix:
            if prefix == "chat_id":
                res = os.path.join(res, chat_id)         # 添加聊天ID
            elif prefix == "media_datetime":
                res = os.path.join(res, media_datetime)  # 添加日期时间
            elif prefix == "media_type":
                res = os.path.join(res, media_type)      # 添加媒体类型
        
        return res
```

#### 2.2 文件名构建 (`module/app.py`)

```python
def get_file_name(
    self, message_id: int, file_name: Optional[str], caption: Optional[str]
) -> str:
    """获取文件名"""
    res: str = ""
    
    for prefix in self.file_name_prefix:
        if prefix == "message_id":
            if res != "":
                res += self.file_name_prefix_split
            res += f"{message_id}"
        elif prefix == "file_name" and file_name:
            if res != "":
                res += self.file_name_prefix_split
            res += f"{file_name}"
        elif prefix == "caption" and caption:
            if res != "":
                res += self.file_name_prefix_split
            res += f"{caption}"
    
    if res == "":
        res = f"{message_id}"
    
    return validate_title(res)
```

### 3. 媒体下载路径构建 (`media_downloader.py`)

#### 3.1 媒体元数据提取

```python
async def _get_media_meta(
    chat_id: Union[int, str],
    message: pyrogram.types.Message,
    media_obj: Union[Audio, Document, Photo, Video, VideoNote, Voice],
    _type: str,
) -> Tuple[str, str, Optional[str]]:
    """提取文件名和文件ID"""
    
    # 获取聊天ID
    dirname = str(chat_id)
    
    # 获取日期时间目录名
    if message.date:
        datetime_dir_name = message.date.strftime(app.date_format)
    else:
        datetime_dir_name = "0"
    
    # 构建文件保存路径
    file_save_path = app.get_file_save_path(_type, dirname, datetime_dir_name)
    
    # 构建文件名
    gen_file_name = (
        app.get_file_name(message.id, file_name, caption) + file_name_suffix
    )
    
    # 构建完整路径
    temp_file_name = os.path.join(app.temp_save_path, dirname, gen_file_name)
    file_name = os.path.join(file_save_path, gen_file_name)
    
    return truncate_filename(file_name), truncate_filename(temp_file_name), file_format
```

## 路径构建流程

### 1. 完整路径构建示例

假设配置如下：
```yaml
save_path: /home/ec2-user/media
file_path_prefix: [chat_id, media_datetime]
file_name_prefix: [message_id, file_name]
date_format: '%Y_%m'
```

对于一条视频消息：
- 聊天ID：`dyjs01`
- 消息日期：`2023-10-15`
- 消息ID：`123`
- 文件名：`sample_video.mp4`

最终路径将是：
```
/home/ec2-user/media/
dyjs01/
2023_10/
123 - sample_video.mp4
```

### 2. 路径构建步骤

1. **基础路径**: `save_path`
2. **添加聊天ID**: `save_path/chat_id`
3. **添加日期时间**: `save_path/chat_id/media_datetime`
4. **构建文件名**: `message_id - file_name`
5. **最终路径**: `save_path/chat_id/media_datetime/message_id - file_name`

## 关键函数说明

### 1. `app.get_file_save_path()`
- **功能**: 根据媒体类型、聊天ID和日期时间构建文件保存路径
- **参数**: 
  - `media_type`: 媒体类型 (video, photo, audio等)
  - `chat_id`: 聊天ID
  - `media_datetime`: 媒体日期时间
- **返回**: 完整的目录路径

### 2. `app.get_file_name()`
- **功能**: 根据消息ID、文件名和标题构建文件名
- **参数**:
  - `message_id`: 消息ID
  - `file_name`: 原始文件名
  - `caption`: 消息标题
- **返回**: 格式化的文件名

### 3. `_get_media_meta()`
- **功能**: 提取媒体元数据并构建完整的文件路径
- **返回**: (最终路径, 临时路径, 文件格式)

## 配置选项说明

### 1. 路径前缀选项
- `chat_id`: 使用聊天ID作为目录
- `media_datetime`: 使用媒体日期时间作为目录
- `media_type`: 使用媒体类型作为目录

### 2. 文件名前缀选项
- `message_id`: 在文件名前添加消息ID
- `file_name`: 保留原始文件名
- `caption`: 使用消息标题作为文件名的一部分

### 3. 日期格式选项
- `%Y_%m`: 年_月 (如: 2023_10)
- `%Y-%m`: 年-月 (如: 2023-10)
- `%Y%m`: 年月 (如: 202310)

## 使用示例

### 1. 基本配置
```yaml
save_path: /home/ec2-user/media
file_path_prefix: [chat_id, media_datetime]
file_name_prefix: [message_id, file_name]
date_format: '%Y_%m'
```

### 2. 自定义配置
```yaml
save_path: /custom/download/path
file_path_prefix: [media_type, chat_id]
file_name_prefix: [caption, message_id]
date_format: '%Y-%m-%d'
```

### 3. 扁平化存储
```yaml
save_path: /flat/storage
file_path_prefix: []  # 空数组，所有文件直接存储在save_path下
file_name_prefix: [chat_id, message_id, file_name]
```

## 注意事项

1. **路径长度限制**: 某些操作系统对路径长度有限制，建议合理配置前缀
2. **特殊字符处理**: 聊天标题中的特殊字符会被`validate_title()`函数处理
3. **权限要求**: 确保程序有写入`save_path`目录的权限
4. **磁盘空间**: 大量下载时注意监控磁盘空间使用情况
5. **并发安全**: 下载状态更新是线程安全的，支持并发下载

这个路径构建系统设计灵活，支持多种配置组合，能够满足不同用户的文件组织需求。 